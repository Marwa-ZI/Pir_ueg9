#!/bin/bash
# postBuild script for bioinformatics environment
# Configurations et installations post-conda

set -e

echo "=== Configuration des kernels Jupyter ==="

# Installation et configuration du kernel R
R --quiet -e "IRkernel::installspec(user = TRUE, name = 'ir', displayname = 'R')"

# Installation du kernel Bash (si pas déjà fait par conda)
python -m bash_kernel.install --user

echo "=== Configuration de VEP ==="
# VEP cache téléchargeable manuellement si nécessaire

echo "=== Configuration de Prokka ==="
prokka --setupdb 2>/dev/null || echo "Prokka database setup completed or already configured"

echo "=== Configuration de Bakta ==="
echo "Bakta est installé. Pour utiliser Bakta, téléchargez la base de données avec:"
echo "  bakta_db download --output ~/bakta_db"

echo "=== Configuration de eggNOG-mapper ==="
echo "eggNOG-mapper est installé. Pour télécharger les bases de données:"
echo "  download_eggnog_data.py -y --data_dir ~/eggnog_data"

echo "=== Installation de BAGEL4 ==="

# Cloner BAGEL4 depuis GitHub
cd /srv/conda/envs/notebook
git clone https://github.com/annejong/BAGEL4.git
cd BAGEL4

# Rendre TOUS les scripts Perl exécutables
chmod +x *.pl
chmod +x *.sh 2>/dev/null || true

# Créer un lien symbolique vers le wrapper principal
ln -sf /srv/conda/envs/notebook/BAGEL4/bagel4_wrapper.pl /srv/conda/bin/bagel4

echo "BAGEL4 installé dans /srv/conda/envs/notebook/BAGEL4"
echo "Utilisation: bagel4 -i input.fasta -s output_folder"

cd ~

echo "=== Configuration de JupyterLab ==="
jupyter lab build --dev-build=False --minimize=True 2>/dev/null || echo "JupyterLab build completed"

echo "=== Configuration terminée ==="

# Création d'un répertoire de travail
mkdir -p ~/work

echo "Configuration complète!"
